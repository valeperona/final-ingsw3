<!-- Header -->
<app-header></app-header>

<!-- Main Content -->
<div class="job-admin-container">
  <!-- Header principal -->
  <div class="page-header">
    <h1 class="page-title">
      <i class="bi bi-rocket-takeoff me-3"></i>
      Administrador de Ofertas
    </h1>
    <div class="header-actions">
      <button class="btn btn-primary btn-lg" (click)="showForm = !showForm">
        <i class="bi {{ showForm ? 'bi-x-lg' : 'bi-plus-lg' }} me-2"></i>
        {{ showForm ? 'Cancelar' : 'Nueva Oferta' }}
      </button>
    </div>
  </div>

  <!-- Stats cards r치pidas -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-icon">
        <i class="bi bi-bar-chart"></i>
      </div>
      <h3 class="stat-value">{{ myJobs.length }}</h3>
      <p class="stat-label">Total Ofertas</p>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <i class="bi bi-check-circle"></i>
      </div>
      <h3 class="stat-value">{{ getActiveJobsCount() }}</h3>
      <p class="stat-label">Ofertas Activas</p>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <i class="bi bi-people"></i>
      </div>
      <h3 class="stat-value">{{ getTotalApplications() }}</h3>
      <p class="stat-label">Aplicaciones</p>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <i class="bi bi-building"></i>
      </div>
      <h3 class="stat-value">{{ companies.length }}</h3>
      <p class="stat-label">Empresas</p>
    </div>
  </div>

  <!-- Formulario modal style -->
  <div *ngIf="showForm" class="form-modal">
    <div class="form-header">
      <div class="form-header-title">
        <i class="bi {{ isEditing ? 'bi-pencil-square' : 'bi-plus-circle' }} me-3"></i>
        <h3>{{ isEditing ? 'Editar Oferta' : 'Crear Nueva Oferta' }}</h3>
      </div>
      <!-- 游뱄 Bot칩n de AI Assistant -->
      <button
        *ngIf="!isEditing"
        type="button"
        class="btn-ai-assistant"
        (click)="openAiAssistant()"
        title="Usar IA para completar campos">
        <i class="bi bi-stars me-2"></i>
        Polo AI Assistant
      </button>
    </div>
    
    <div class="form-body">
      <div class="form-grid">
        <!-- Empresa (solo visible para recruiters) -->
        <div class="form-field" *ngIf="currentUserRole !== 'empresa'">
          <label>
            <i class="bi bi-building me-2"></i>
            Empresa *
          </label>
          <select [(ngModel)]="job.company_id" [class.error]="errors.includes('company')">
            <option value="">Seleccionar empresa...</option>
            <option *ngFor="let company of companies" [value]="company.id">
              {{ company.nombre }}
            </option>
          </select>
        </div>

        <!-- Empresa (info para empresas - no editable) -->
        <div class="form-field" *ngIf="currentUserRole === 'empresa'" style="opacity: 0.7;">
          <label>
            <i class="bi bi-building me-2"></i>
            Empresa
          </label>
          <input
            type="text"
            [value]="companies[0]?.nombre || 'Mi Empresa'"
            disabled
            style="background: #e9ecef; cursor: not-allowed;">
        </div>

        <!-- T칤tulo -->
        <div class="form-field">
          <label>
            <i class="bi bi-briefcase me-2"></i>
            T칤tulo del Puesto *
          </label>
          <input 
            type="text" 
            [(ngModel)]="job.title"
            placeholder="ej. Desarrollador Full Stack Senior"
            [class.error]="errors.includes('title')">
        </div>

        <!-- 游 NUEVO: Estado de la oferta (solo al editar) -->
        <div class="form-field" *ngIf="isEditing">
          <label>
            <i class="bi bi-toggle-on me-2"></i>
            Estado de la Oferta
          </label>
          <select [(ngModel)]="job.status">
            <option value="active">Activa</option>
            <option value="paused">Pausada</option>
            <option value="closed">Cerrada</option>
          </select>
        </div>

        <!-- Tipo de trabajo -->
        <div class="form-field">
          <label>
            <i class="bi bi-clock me-2"></i>
            Tipo de Contrato
          </label>
          <select [(ngModel)]="job.job_type">
            <option value="full_time">Tiempo Completo</option>
            <option value="part_time">Medio Tiempo</option>
            <option value="contract">Contrato</option>
            <option value="internship">Pasant칤a</option>
            <option value="temporary">Temporal</option>
          </select>
        </div>

        <!-- Modalidad -->
        <div class="form-field">
          <label>
            <i class="bi bi-geo-alt me-2"></i>
            Modalidad de Trabajo
          </label>
          <select [(ngModel)]="job.work_modality">
            <option value="onsite">Presencial</option>
            <option value="remote">Remoto</option>
            <option value="hybrid">H칤brido</option>
          </select>
        </div>

        <!-- Ubicaci칩n -->
        <div class="form-field">
          <label>
            <i class="bi bi-map me-2"></i>
            Ubicaci칩n
          </label>
          <input 
            type="text" 
            [(ngModel)]="job.location"
            placeholder="ej. Buenos Aires, Argentina">
        </div>

        <!-- Vacantes -->
        <div class="form-field">
          <label>
            <i class="bi bi-people me-2"></i>
            N칰mero de Vacantes
          </label>
          <input 
            type="number" 
            [(ngModel)]="job.positions_available"
            min="1"
            placeholder="1">
        </div>

        <!-- Experiencia M칤nima -->
        <div class="form-field">
          <label>
            <i class="bi bi-book me-2"></i>
            Experiencia M칤nima (a침os)
          </label>
          <input 
            type="number" 
            [(ngModel)]="job.min_experience_years"
            min="0"
            placeholder="0 = Sin experiencia"
            [class.error]="errors.includes('min_experience')">
        </div>

        <!-- Experiencia M치xima -->
        <div class="form-field">
          <label>
            <i class="bi bi-bullseye me-2"></i>
            Experiencia M치xima (a침os)
          </label>
          <input 
            type="number" 
            [(ngModel)]="job.max_experience_years"
            placeholder="Opcional - ej: 5"
            [class.error]="errors.includes('max_experience')">
        </div>

        <!-- Salario m칤nimo -->
        <div class="form-field">
          <label>
            <i class="bi bi-currency-dollar me-2"></i>
            Salario M칤nimo
          </label>
          <input 
            type="number" 
            [(ngModel)]="job.salary_min"
            placeholder="ej. 50000"
            [class.error]="errors.includes('salary')">
        </div>

        <!-- Salario m치ximo -->
        <div class="form-field">
          <label>
            <i class="bi bi-gem me-2"></i>
            Salario M치ximo
          </label>
          <input 
            type="number" 
            [(ngModel)]="job.salary_max"
            placeholder="ej. 80000"
            [class.error]="errors.includes('salary')">
        </div>

        <!-- Descripci칩n -->
        <div class="form-field full-width">
          <label>
            <i class="bi bi-file-text me-2"></i>
            Descripci칩n del Puesto *
          </label>
          <textarea 
            [(ngModel)]="job.description"
            placeholder="Describe las responsabilidades, objetivos y expectativas del puesto..."
            rows="4"
            [class.error]="errors.includes('description')">
          </textarea>
        </div>

        <!-- Requisitos -->
        <div class="form-field full-width">
          <label>
            <i class="bi bi-list-check me-2"></i>
            Requisitos y Habilidades
          </label>
          <textarea 
            [(ngModel)]="job.requirements"
            placeholder="Lista los requisitos t칠cnicos, experiencia necesaria, habilidades..."
            rows="3">
          </textarea>
        </div>
      </div>

      <!-- 游 Gesti칩n de Recruiters (visible para todos en modo edici칩n) -->
      <div *ngIf="isEditing" class="recruiter-management-section"
           style="margin-top: 24px; padding: 20px; background: #f5f5f5; border-radius: 8px; border: 1px solid #adb5bd;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 style="margin: 0; color: #495057;">
            <i class="bi bi-people-fill me-2"></i>
            Gesti칩n de Recruiters
          </h5>
          <button
            type="button"
            class="btn btn-sm"
            style="border: 1px solid #9B1B30; color: #9B1B30; background: transparent; transition: all 0.2s;"
            onmouseover="this.style.background='#9B1B30'; this.style.color='white'"
            onmouseout="this.style.background='transparent'; this.style.color='#9B1B30'"
            (click)="showRecruiterManagement = !showRecruiterManagement">
            <i class="bi" [ngClass]="showRecruiterManagement ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
            {{ showRecruiterManagement ? 'Ocultar' : 'Mostrar' }}
          </button>
        </div>

        <div *ngIf="showRecruiterManagement">
          <!-- Recruiters actualmente asignados -->
          <div *ngIf="assignedRecruiters.length > 0" class="mb-3">
            <p style="font-weight: 500; color: #495057; margin-bottom: 8px;">
              Recruiters Asignados:
            </p>
            <div class="d-flex flex-wrap gap-2">
              <span *ngFor="let recruiter of assignedRecruiters"
                    class="badge"
                    style="font-size: 13px; padding: 6px 12px; background: #9B1B30; color: white;">
                <i class="bi bi-person-check-fill me-1"></i>
                {{ recruiter.nombre }} {{ recruiter.apellido }}
              </span>
            </div>
          </div>

          <div *ngIf="assignedRecruiters.length === 0" class="mb-3">
            <p style="color: #6c757d; font-style: italic; margin: 0;">
              No hay recruiters asignados a esta oferta.
            </p>
          </div>

          <!-- Solo empresas pueden modificar asignaciones -->
          <div *ngIf="currentUserRole === 'empresa'">
            <hr style="margin: 16px 0;">

            <!-- Selector de recruiters -->
            <div *ngIf="availableRecruiters.length > 0">
            <p style="font-weight: 500; color: #495057; margin-bottom: 12px;">
              Selecciona recruiters para asignar:
            </p>
            <div class="recruiter-checkboxes"
                 style="display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; padding: 8px;">
              <label *ngFor="let recruiter of availableRecruiters"
                     class="recruiter-checkbox-label"
                     style="display: flex; align-items: center; padding: 8px 12px; background: white; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer; transition: all 0.2s;"
                     [style.background]="isRecruiterSelected(recruiter.id) ? '#fce4e6' : 'white'"
                     [style.border-color]="isRecruiterSelected(recruiter.id) ? '#9B1B30' : '#dee2e6'">
                <input
                  type="checkbox"
                  [checked]="isRecruiterSelected(recruiter.id)"
                  (change)="toggleRecruiterSelection(recruiter.id)"
                  style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer; accent-color: #9B1B30;">
                <span style="font-weight: 500;">{{ recruiter.nombre }} {{ recruiter.apellido }}</span>
                <span style="margin-left: auto; font-size: 12px; color: #6c757d;">{{ recruiter.email }}</span>
              </label>
            </div>

            <button
              type="button"
              class="btn mt-3 w-100"
              style="background: #9B1B30; color: white; border: none; padding: 10px; font-weight: 500; transition: all 0.2s;"
              onmouseover="this.style.background='#7a1626'"
              onmouseout="this.style.background='#9B1B30'"
              (click)="assignRecruitersToJob()"
              [disabled]="loading">
              <i class="bi bi-check2-circle me-2"></i>
              Guardar Asignaci칩n de Recruiters
            </button>
          </div>

            <div *ngIf="availableRecruiters.length === 0" style="color: #6c757d; font-style: italic;">
              No tienes recruiters disponibles. Agrega recruiters a tu empresa desde el panel de administraci칩n.
            </div>
          </div>
        </div>
      </div>

      <!-- Mensajes de error -->
      <div *ngIf="errors.length > 0" class="error-message">
        <i class="bi bi-exclamation-triangle"></i>
        <div>
          <strong>Por favor corrige los siguientes errores:</strong>
          <ul style="margin: 8px 0 0 0; padding-left: 20px;">
            <li *ngIf="errors.includes('title')">El t칤tulo debe tener al menos 3 caracteres</li>
            <li *ngIf="errors.includes('description')">La descripci칩n debe tener al menos 10 caracteres</li>
            <li *ngIf="errors.includes('company')">Debes seleccionar una empresa</li>
            <li *ngIf="errors.includes('salary')">El salario m치ximo debe ser mayor que el m칤nimo</li>
            <li *ngIf="errors.includes('min_experience')">La experiencia m칤nima no puede ser negativa</li>
            <li *ngIf="errors.includes('max_experience')">La experiencia m치xima debe ser mayor que la m칤nima</li>
            <li *ngIf="errors.includes('positions')">Debe haber al menos 1 vacante disponible</li>
          </ul>
        </div>
      </div>

      <!-- Botones del formulario -->
      <div class="form-actions">
        <button 
          class="btn btn-secondary" 
          (click)="cancelEdit()" 
          *ngIf="isEditing"
          [disabled]="loading">
          <i class="bi bi-x-lg me-2"></i>
          Cancelar
        </button>
        <button
          class="btn btn-lg"
          style="background: #f5f5f5; color: #9B1B30; border: 2px solid #9B1B30; font-weight: 500; transition: all 0.2s;"
          onmouseover="this.style.background='#9B1B30'; this.style.color='white'"
          onmouseout="this.style.background='#f5f5f5'; this.style.color='#9B1B30'"
          (click)="saveJob()"
          [disabled]="loading">
          <span class="loading-spinner" *ngIf="loading">
            <div class="spinner"></div>
            {{ isEditing ? 'Actualizando...' : 'Creando...' }}
          </span>
          <span *ngIf="!loading">
            <i class="bi {{ isEditing ? 'bi-floppy' : 'bi-rocket-takeoff' }} me-2"></i>
            {{ isEditing ? 'Actualizar Oferta' : 'Crear Oferta' }}
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- Secci칩n de ofertas -->
  <div class="jobs-section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="bi bi-clipboard-data me-3"></i>
        Mis Ofertas Publicadas
        <span style="background: #e9ecef; color: #6c757d; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-left: 12px;">
          {{ myJobs.length }}
        </span>
      </h2>
    </div>
    
    <div class="section-body">
      <!-- Estado vac칤o -->
      <div *ngIf="myJobs.length === 0" class="empty-state">
        <div class="empty-state-icon">
          <i class="bi bi-binoculars"></i>
        </div>
        <h3 class="empty-state-title">No tienes ofertas publicadas</h3>
        <p class="empty-state-subtitle">Crea tu primera oferta laboral para comenzar a recibir aplicaciones</p>
        <button class="btn btn-primary btn-lg" (click)="showForm = true" style="margin-top: 20px;">
          <i class="bi bi-plus-lg me-2"></i>
          Crear Primera Oferta
        </button>
      </div>

      <!-- Tabla de ofertas -->
      <table *ngIf="myJobs.length > 0" class="jobs-table">
        <thead>
          <tr>
            <th>
              <i class="bi bi-briefcase me-2"></i>
              Puesto
            </th>
            <th>
              <i class="bi bi-building me-2"></i>
              Empresa
            </th>
            <th>
              <i class="bi bi-geo-alt me-2"></i>
              Modalidad
            </th>
            <th>
              <i class="bi bi-bar-chart me-2"></i>
              Estado
            </th>
            <th class="hide-mobile">
              <i class="bi bi-people me-2"></i>
              Aplicaciones
            </th>
            <th class="hide-mobile">
              <i class="bi bi-book me-2"></i>
              Experiencia
            </th>
            <th>
              <i class="bi bi-gear me-2"></i>
              Acciones
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let job of myJobs; trackBy: trackByJobId">
            <td>
              <div>
                <h4 class="job-title">{{ job.title }}</h4>
                <div class="job-company">{{ job.company_name }}</div>
              </div>
            </td>
            <td>
              <span style="font-weight: 500;">{{ job.company_name }}</span>
            </td>
            <td>
              <span class="job-status" [ngClass]="'status-' + getModalityClass(job.work_modality)">
                <i class="bi {{ getModalityIcon(job.work_modality) }} me-1"></i>
                {{ getModalityText(job.work_modality) }}
              </span>
            </td>
            <td>
              <span class="job-status" [ngClass]="'status-' + job.status">
                <i class="bi {{ getStatusIcon(job.status) }} me-1"></i>
                {{ getStatusText(job.status) }}
              </span>
            </td>
            <td class="hide-mobile">
              <span class="job-applications">{{ job.application_count || 0 }}</span>
            </td>
            <td class="hide-mobile">
              <span class="job-experience">{{ formatExperienceDisplay(job) }}</span>
            </td>
            <td>
              <div class="job-actions">
                <button
                  class="btn btn-sm"
                  style="background: #f5f5f5; color: #ffc107; border: 2px solid #ffc107; font-weight: 500; transition: all 0.2s;"
                  onmouseover="this.style.background='#ffc107'; this.style.color='#212529'"
                  onmouseout="this.style.background='#f5f5f5'; this.style.color='#ffc107'"
                  (click)="editJob(job)"
                  title="Editar oferta">
                  <i class="bi bi-pencil-square me-1"></i>
                  Editar
                </button>
                <button
                  class="btn btn-sm"
                  style="background: #f5f5f5; color: #9B1B30; border: 2px solid #9B1B30; font-weight: 500; transition: all 0.2s;"
                  onmouseover="this.style.background='#9B1B30'; this.style.color='white'"
                  onmouseout="this.style.background='#f5f5f5'; this.style.color='#9B1B30'"
                  (click)="viewApplications(job)"
                  title="Ver aplicaciones">
                  <i class="bi bi-people me-1"></i>
                  {{ job.application_count || 0 }}
                </button>
                <button
                  class="btn btn-sm"
                  style="background: #f5f5f5; color: #dc3545; border: 2px solid #dc3545; font-weight: 500; transition: all 0.2s;"
                  onmouseover="this.style.background='#dc3545'; this.style.color='white'"
                  onmouseout="this.style.background='#f5f5f5'; this.style.color='#dc3545'"
                  (click)="deleteJob(job.id)"
                  title="Eliminar oferta">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal de aplicaciones -->
  <app-job-applications-modal 
    [isVisible]="showApplicationsModal"
    [jobId]="selectedJobId"
    [jobTitle]="selectedJobTitle"
    [companyName]="selectedCompanyName"
    (closeModalEvent)="closeApplicationsModal()"
    (notificationEvent)="handleModalNotification($event)">
  </app-job-applications-modal>

  <!-- Notifications -->
  <div class="notification success" *ngIf="showSuccessNotification">
    <i class="bi bi-check-circle" style="font-size: 18px;"></i>
    <div>
      <strong>춰칄xito!</strong>
      <div style="font-size: 13px; color: #6c757d; margin-top: 4px;">
        {{ successMessage }}
      </div>
    </div>
  </div>

  <div class="notification error" *ngIf="showErrorNotification">
    <i class="bi bi-x-circle" style="font-size: 18px;"></i>
    <div>
      <strong>Error</strong>
      <div style="font-size: 13px; color: #6c757d; margin-top: 4px;">
        {{ errorMessage }}
      </div>
    </div>
  </div>
</div>

<!-- 游뱄 Modal de AI Assistant -->
<app-ai-assistant-modal
  *ngIf="showAiAssistantModal"
  [companyName]="getSelectedCompanyName()"
  (close)="closeAiAssistant()"
  (fieldsGenerated)="handleGeneratedFields($event)">
</app-ai-assistant-modal>

<!-- Footer -->
<app-footer></app-footer>
<!-- Overlay del modal -->
<div *ngIf="isVisible" class="modal-overlay" (click)="closeModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    
    <!-- Header del modal -->
    <div class="modal-header">
      <div class="modal-title-section">
        <i class="bi bi-people-fill me-3"></i>
        <div>
          <h2 class="modal-title">Aplicaciones del puesto</h2>
          <!--  NUEVO: Mostrar tanto el t铆tulo como la empresa -->
          <p class="modal-subtitle">
            {{ jobTitle || 'Cargando...' }}
            <span *ngIf="companyName && jobTitle" class="company-separator"> en </span>
            <span *ngIf="companyName" class="company-name">{{ companyName }}</span>
          </p>
        </div>
      </div>
      <button class="btn-close" (click)="closeModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- Stats r谩pidas -->
    <div class="modal-stats">
      <div class="stat-item">
        <i class="bi bi-people-fill"></i>
        <span class="stat-number">{{ applications.length }}</span>
        <span class="stat-label">Total</span>
      </div>
      <div class="stat-item">
        <i class="bi bi-clock-history"></i>
        <span class="stat-number">{{ getPendingCount() }}</span>
        <span class="stat-label">Pendientes</span>
      </div>
      <div class="stat-item">
        <i class="bi bi-star-fill"></i>
        <span class="stat-number">{{ getShortlistedCount() }}</span>
        <span class="stat-label">Destacados</span>
      </div>
      <div class="stat-item">
        <i class="bi bi-check-circle-fill"></i>
        <span class="stat-number">{{ getAcceptedCount() }}</span>
        <span class="stat-label">Aceptados</span>
      </div>
    </div>

    <!-- Filtros -->
    <div class="modal-filters">
      <div class="filter-group">
        <label>
          <i class="bi bi-funnel me-2"></i>
          Filtrar por estado:
        </label>
        <select [(ngModel)]="selectedStatus" (ngModelChange)="filterApplications()">
          <option value="">Todos los estados</option>
          <option value="applied">Pendientes</option>
          <option value="reviewing">En revisi贸n</option>
          <option value="shortlisted">Preseleccionados</option>
          <option value="interview_scheduled">Entrevista programada</option>
          <option value="interviewed">Entrevistados</option>
          <option value="rejected">Rechazados</option>
          <option value="accepted">Aceptados</option>
          <option value="withdrawn">Retirados</option>
        </select>
      </div>
      <div class="filter-group">
        <label>
          <i class="bi bi-search me-2"></i>
          Buscar candidato:
        </label>
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          (ngModelChange)="filterApplications()"
          placeholder="Nombre, apellido o email...">
      </div>
    </div>

    <!-- Contenido del modal -->
    <div class="modal-body">
      <!-- Loading state -->
      <div *ngIf="loading" class="loading-state">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <span>Cargando aplicaciones...</span>
        </div>
      </div>

      <!-- Empty state -->
      <div *ngIf="!loading && filteredApplications.length === 0" class="empty-state">
        <div class="empty-state-icon">
          <i class="bi bi-inbox"></i>
        </div>
        <h3 class="empty-state-title">
          {{ applications.length === 0 ? 'No hay aplicaciones' : 'No se encontraron candidatos' }}
        </h3>
        <p class="empty-state-subtitle">
          {{ applications.length === 0 
            ? 'A煤n no se han recibido aplicaciones para este puesto.' 
            : 'Intenta cambiar los filtros para ver m谩s candidatos.' }}
        </p>
      </div>

      <!-- Lista de aplicaciones -->
      <div *ngIf="!loading && filteredApplications.length > 0" class="applications-list">
        <div *ngFor="let application of filteredApplications; trackBy: trackByApplicationId" 
             class="application-card clickable-card"
             (click)="openCandidateDetail(application)">
          
          <!-- Header de la aplicaci贸n -->
          <div class="application-header">
            <div class="applicant-info">
              <div class="applicant-avatar">
                <i class="bi bi-person-fill"></i>
              </div>
              <div class="applicant-details">
                <h4 class="applicant-name">
                  {{ application.user_data?.nombre || 'Nombre' }} 
                  {{ application.user_data?.apellido || 'Apellido' }}
                </h4>
                <p class="applicant-email">
                  <i class="bi bi-envelope me-2"></i>
                  {{ application.user_data?.email || 'email@ejemplo.com' }}
                </p>
              </div>
            </div>
            <div class="application-status">
              <div class="status-badges">
                <span class="status-badge" [ngClass]="'status-' + getStatusColor(application.status)">
                  <i class="bi {{ getStatusIcon(application.status) }} me-1"></i>
                  {{ formatStatus(application.status) }}
                </span>
                <!--  Badge de matcheo -->
                <span *ngIf="application.match_percentage !== undefined"
                      class="match-badge"
                      [ngClass]="'match-' + getMatchColor(application.match_percentage)">
                  <i class="bi bi-percent me-1"></i>
                  {{ application.match_percentage }}% Match
                </span>
              </div>
              <small class="application-date">
                {{ formatTimeAgo(application.application_date) }}
              </small>
            </div>
          </div>

          <!-- Informaci贸n personal -->
          <div class="applicant-personal-info">
            <div class="info-grid">
              <div class="info-item">
                <i class="bi bi-calendar3 me-2"></i>
                <span class="info-label">Fecha de nacimiento:</span>
                <span class="info-value">
                  {{ formatBirthDate(application.user_data?.fecha_nacimiento) }}
                </span>
              </div>
              <div class="info-item" *ngIf="application.user_data?.telefono">
                <i class="bi bi-phone me-2"></i>
                <span class="info-label">Tel茅fono:</span>
                <span class="info-value">{{ application.user_data?.telefono }}</span>
              </div>
              <div class="info-item" *ngIf="application.user_data?.ubicacion">
                <i class="bi bi-geo-alt me-2"></i>
                <span class="info-label">Ubicaci贸n:</span>
                <span class="info-value">{{ application.user_data?.ubicacion }}</span>
              </div>
            </div>
          </div>

          <!-- CV y carta de presentaci贸n -->
          <div class="application-documents">
            <div class="document-section" *ngIf="application.resume_url">
              <button class="btn btn-primary btn-sm" 
                      (click)="downloadCV(application.resume_url); $event.stopPropagation()">
                <i class="bi bi-download me-2"></i>
                Descargar CV
              </button>
            </div>
            <div class="document-section" *ngIf="application.cover_letter">
              <div class="cover-letter">
                <h5>
                  <i class="bi bi-file-text me-2"></i>
                  Carta de presentaci贸n:
                </h5>
                <p class="cover-letter-text">{{ application.cover_letter }}</p>
              </div>
            </div>
          </div>

          <!-- Acciones -->
          <div class="application-actions">
            <button class="btn btn-success btn-sm" 
                    *ngIf="application.status === 'applied' || application.status === 'reviewing'"
                    (click)="updateApplicationStatus(application.id, 'shortlisted'); $event.stopPropagation()">
              <i class="bi bi-star me-1"></i>
              Destacar
            </button>
            <button class="btn btn-primary btn-sm"
                    *ngIf="application.status === 'shortlisted'"
                    (click)="updateApplicationStatus(application.id, 'interview_scheduled'); $event.stopPropagation()">
              <i class="bi bi-calendar-check me-1"></i>
              Programar entrevista
            </button>
            <button class="btn btn-warning btn-sm"
                    *ngIf="application.status === 'interview_scheduled'"
                    (click)="updateApplicationStatus(application.id, 'interviewed'); $event.stopPropagation()">
              <i class="bi bi-chat-dots me-1"></i>
              Marcar entrevistado
            </button>
            <button class="btn btn-success btn-sm"
                    *ngIf="['shortlisted', 'interviewed'].includes(application.status)"
                    (click)="updateApplicationStatus(application.id, 'accepted'); $event.stopPropagation()">
              <i class="bi bi-check-circle me-1"></i>
              Aceptar
            </button>
            <button class="btn btn-danger btn-sm"
                    *ngIf="!['rejected', 'accepted'].includes(application.status)"
                    (click)="updateApplicationStatus(application.id, 'rejected'); $event.stopPropagation()">
              <i class="bi bi-x-circle me-1"></i>
              Rechazar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer del modal -->
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">
        <i class="bi bi-x-lg me-2"></i>
        Cerrar
      </button>
      <div class="footer-actions">
        <!--  Bot贸n de Calcular Matcheo -->
        <button class="btn btn-success"
                (click)="calculateMatcheo()"
                [disabled]="calculatingMatcheo || applications.length === 0">
          <i class="bi bi-magic me-2"></i>
          {{ calculatingMatcheo ? 'Calculando...' : 'Calcular Matcheo' }}
        </button>
        <button class="btn btn-primary" (click)="exportApplications()" [disabled]="applications.length === 0">
          <i class="bi bi-download me-2"></i>
          Exportar lista
        </button>
      </div>
    </div>
  </div>
  
  <!-- Modal de detalle del candidato -->
  <app-candidate-detail-modal
    [isVisible]="showCandidateDetail"
    [candidate]="selectedCandidate"
    (closeModalEvent)="closeCandidateDetail()"
    (candidateUpdatedEvent)="onCandidateUpdated($event)"
    (notificationEvent)="onCandidateDetailNotification($event)">
  </app-candidate-detail-modal>
</div>
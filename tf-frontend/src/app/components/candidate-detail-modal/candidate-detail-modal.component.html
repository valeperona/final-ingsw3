<!-- Overlay del modal -->
<div *ngIf="isVisible" class="modal-overlay" (click)="closeModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    
    <!-- Header del modal -->
    <div class="modal-header">
      <div class="candidate-header">
        <div class="candidate-avatar-large">
          <i class="bi bi-person-fill"></i>
        </div>
        <div class="candidate-main-info">
          <h1 class="candidate-name">
            {{ candidate?.user_data?.nombre || 'Nombre' }} 
            {{ candidate?.user_data?.apellido || 'Apellido' }}
          </h1>
          <p class="candidate-email">
            <i class="bi bi-envelope me-2"></i>
            {{ candidate?.user_data?.email || 'email@ejemplo.com' }}
          </p>
          <div class="candidate-status">
            <span class="status-badge-large" [ngClass]="'status-' + getStatusColor(candidate?.status || '')">
              <i class="bi {{ getStatusIcon(candidate?.status || '') }} me-2"></i>
              {{ formatStatus(candidate?.status || '') }}
            </span>
          </div>
        </div>
      </div>
      <button class="btn-close-large" (click)="closeModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- Contenido con scroll -->
    <div class="modal-body">
      
      <!-- Información personal -->
      <div class="modal-section">
        <h3 class="section-title">
          <i class="bi bi-person-vcard me-2"></i>
          Información Personal
        </h3>
        <div class="info-grid-detailed">
          <div class="info-card" *ngIf="candidate?.user_data?.fecha_nacimiento">
            <div class="info-icon">
              <i class="bi bi-calendar3"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Fecha de Nacimiento</span>
              <span class="info-value">{{ formatBirthDate(candidate?.user_data?.fecha_nacimiento) }}</span>
            </div>
          </div>
          
          <div class="info-card" *ngIf="candidate?.user_data?.telefono">
            <div class="info-icon">
              <i class="bi bi-phone"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Teléfono</span>
              <span class="info-value">{{ candidate?.user_data?.telefono }}</span>
            </div>
          </div>
          
          <div class="info-card" *ngIf="candidate?.user_data?.ubicacion">
            <div class="info-icon">
              <i class="bi bi-geo-alt"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Ubicación</span>
              <span class="info-value">{{ candidate?.user_data?.ubicacion }}</span>
            </div>
          </div>
          
          <div class="info-card">
            <div class="info-icon">
              <i class="bi bi-clock-history"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Aplicó</span>
              <span class="info-value">{{ formatTimeAgo(candidate?.application_date || '') }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Enlaces profesionales -->
      <div class="modal-section" 
           *ngIf="candidate?.user_data?.linkedin_url || candidate?.user_data?.github_url || candidate?.user_data?.portfolio_url">
        <h3 class="section-title">
          <i class="bi bi-link-45deg me-2"></i>
          Enlaces Profesionales
        </h3>
        <div class="links-container">
          <a *ngIf="candidate?.user_data?.linkedin_url" 
             [href]="candidate?.user_data?.linkedin_url || ''" 
             target="_blank" 
             class="profile-link linkedin">
            <i class="bi bi-linkedin"></i>
            LinkedIn
          </a>
          <a *ngIf="candidate?.user_data?.github_url" 
             [href]="candidate?.user_data?.github_url || ''" 
             target="_blank" 
             class="profile-link github">
            <i class="bi bi-github"></i>
            GitHub
          </a>
          <a *ngIf="candidate?.user_data?.portfolio_url" 
             [href]="candidate?.user_data?.portfolio_url || ''" 
             target="_blank" 
             class="profile-link portfolio">
            <i class="bi bi-globe"></i>
            Portfolio
          </a>
        </div>
      </div>

      <!-- Biografía -->
      <div class="modal-section" *ngIf="candidate?.user_data?.biografia">
        <h3 class="section-title">
          <i class="bi bi-file-text me-2"></i>
          Biografía
        </h3>
        <div class="biography-content">
          <p>{{ candidate?.user_data?.biografia }}</p>
        </div>
      </div>

      <!-- CV y Carta de presentación ACTUALIZADA -->
      <div class="modal-section">
        <h3 class="section-title">
          <i class="bi bi-file-earmark-text me-2"></i>
          Documentos
        </h3>
        <div class="documents-grid">
          <!-- Currículum Vitae -->
          <div class="document-card" *ngIf="hasCv()">
            <div class="document-icon">
              <i class="bi bi-file-earmark-pdf"></i>
            </div>
            <div class="document-info">
              <span class="document-name">Currículum Vitae</span>
              <span class="document-type">PDF</span>
            </div>
            <button class="btn btn-outline" (click)="downloadCV(candidate?.resume_url || candidate?.user_data?.cv_filename)">
              <i class="bi bi-download me-2"></i>
              Descargar
            </button>
          </div>

          <!-- Análisis de CV -->
          <div class="document-card cv-analysis-card" *ngIf="hasCvAnalysis()">
            <div class="document-icon">
              <i class="bi bi-graph-up"></i>
            </div>
            <div class="document-info">
              <span class="document-name">Análisis de CV (IA)</span>
              <span class="document-type">JSON</span>
              <button class="btn-link" (click)="showCvAnalysis = !showCvAnalysis">
                {{ showCvAnalysis ? 'Ocultar' : 'Ver análisis' }}
                <i class="bi" [ngClass]="showCvAnalysis ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
              </button>
            </div>
          </div>
          
          <!-- Carta de presentación -->
          <div class="document-card cover-letter-card" *ngIf="candidate?.cover_letter">
            <div class="document-icon">
              <i class="bi bi-envelope-open"></i>
            </div>
            <div class="document-info">
              <span class="document-name">Carta de Presentación</span>
              <button class="btn-link" (click)="showCoverLetter = !showCoverLetter">
                {{ showCoverLetter ? 'Ocultar' : 'Ver carta' }}
                <i class="bi" [ngClass]="showCoverLetter ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Análisis de CV expandible -->
        <div class="cv-analysis-expanded" *ngIf="showCvAnalysis && hasCvAnalysis()">
          <div class="cv-analysis-content">
            <h4>
              <i class="bi bi-graph-up me-2"></i>
              Análisis de CV por IA
            </h4>
            <div class="analysis-json">
              <pre>{{ formatJsonAnalysis(candidate?.user_data?.cv_analizado) }}</pre>
            </div>
          </div>
        </div>
        
        <!-- Carta de presentación expandible -->
        <div class="cover-letter-expanded" *ngIf="showCoverLetter && candidate?.cover_letter">
          <div class="cover-letter-content">
            <h4>
              <i class="bi bi-envelope-open me-2"></i>
              Carta de Presentación
            </h4>
            <p>{{ candidate?.cover_letter }}</p>
          </div>
        </div>
      </div>

      <!-- SECCIÓN CORREGIDA: Cambiar estado - TODOS LOS ESTADOS SIEMPRE VISIBLES -->
      <div class="modal-section">
        <h3 class="section-title">
          <i class="bi bi-arrow-repeat me-2"></i>
          Gestión de Candidatura
        </h3>
        
        <div class="status-management">
          <div class="current-status">
            <span class="current-status-label">Estado actual:</span>
            <span class="status-badge" [ngClass]="'status-' + getStatusColor(candidate?.status || '')">
              <i class="bi {{ getStatusIcon(candidate?.status || '') }} me-1"></i>
              {{ formatStatus(candidate?.status || '') }}
            </span>
          </div>
          
          <div class="status-actions">
            <h4>Cambiar estado a:</h4>
            <div class="status-buttons">
              <!-- Usando ngFor para mostrar todos los estados -->
              <button 
                *ngFor="let status of allStatuses"
                class="status-action-btn {{ status.class }}" 
                (click)="updateStatus(status.key)"
                [disabled]="updating">
                <i class="bi {{ status.icon }} me-2"></i>
                {{ status.label }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Notas del recruiter -->
      <div class="modal-section">
        <h3 class="section-title">
          <i class="bi bi-journal-text me-2"></i>
          Notas del Recruiter
        </h3>
        <div class="notes-section">
          <textarea 
            [(ngModel)]="recruiterNotes" 
            placeholder="Agrega notas sobre este candidato..."
            class="notes-textarea"
            rows="4">
          </textarea>
          <button class="btn btn-primary" 
                  (click)="saveNotes()" 
                  [disabled]="updating">
            <i class="bi bi-save me-2"></i>
            {{ updating ? 'Guardando...' : 'Guardar Notas' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Footer del modal -->
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">
        <i class="bi bi-x-lg me-2"></i>
        Cerrar
      </button>
      <button class="btn btn-primary" (click)="downloadCV(candidate?.resume_url || candidate?.user_data?.cv_filename)" 
              *ngIf="hasCv()">
        <i class="bi bi-download me-2"></i>
        Descargar CV
      </button>
    </div>
  </div>
</div>
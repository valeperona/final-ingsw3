name: Deploy

on:
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: final-ingsoft3-2025-480515
  REGION: us-central1
  REGISTRY_HOST: us-central1-docker.pkg.dev
  REPOSITORY: cloud-run-source-deploy

jobs:
  # ============================================
  # FASE 1: Tests en paralelo
  # ============================================
  test-backend:
    name: Test Backend (Pytest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd APIs/UserAPI
          pip install -r requirements.txt

      - name: Run tests with coverage
        run: |
          cd APIs/UserAPI
          DATABASE_URL="sqlite:///test.db" python -m pytest tests/test_complete.py -v --cov=. --cov-report=term-missing --cov-report=xml

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./APIs/UserAPI/coverage.xml
          flags: backend
          name: backend-coverage
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  test-frontend:
    name: Test Frontend (Angular)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tf-frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd tf-frontend
          npm ci

      - name: Run tests with coverage
        env:
          CHROME_BIN: /usr/bin/google-chrome
        run: |
          cd tf-frontend
          npm test -- --watch=false --code-coverage --browsers=ChromeHeadlessNoSandbox

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./tf-frontend/coverage/tf-frontend/lcov.info
          flags: frontend
          name: frontend-coverage
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  # ============================================
  # FASE 2: SonarCloud Analysis (necesita coverage)
  # ============================================
  # TEMPORALMENTE COMENTADO PARA TESTS MÁS RÁPIDOS
  # sonarcloud:
  #   name: SonarCloud Analysis
  #   runs-on: ubuntu-latest
  #   needs: [test-backend, test-frontend]
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0  # Shallow clones should be disabled for better analysis

  #     - name: Set up Python 3.12
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.12'

  #     - name: Install backend dependencies
  #       run: |
  #         cd APIs/UserAPI
  #         pip install -r requirements.txt

  #     - name: Run backend tests with coverage
  #       run: |
  #         cd APIs/UserAPI
  #         DATABASE_URL="sqlite:///test.db" python -m pytest tests/test_complete.py -v --cov=. --cov-report=xml:coverage.xml --cov-report=term

  #     - name: Verify backend coverage file
  #       run: |
  #         echo "Checking for coverage.xml in APIs/UserAPI..."
  #         ls -la APIs/UserAPI/coverage.xml || echo "Backend coverage.xml not found!"
  #         if [ -f APIs/UserAPI/coverage.xml ]; then
  #           echo "Coverage file size:"
  #           du -h APIs/UserAPI/coverage.xml
  #           echo "First 20 lines of coverage.xml:"
  #           head -20 APIs/UserAPI/coverage.xml
  #         fi

  #     - name: Set up Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'
  #         cache-dependency-path: tf-frontend/package-lock.json

  #     - name: Install frontend dependencies
  #       run: |
  #         cd tf-frontend
  #         npm ci

  #     - name: Run frontend tests with coverage
  #       env:
  #         CHROME_BIN: /usr/bin/google-chrome
  #       run: |
  #         cd tf-frontend
  #         npm test -- --watch=false --code-coverage --browsers=ChromeHeadlessNoSandbox

  #     - name: Verify frontend coverage file
  #       run: |
  #         echo "Checking for lcov.info in tf-frontend/coverage..."
  #         ls -la tf-frontend/coverage/tf-frontend/lcov.info || echo "Frontend coverage file not found!"
  #         if [ -f tf-frontend/coverage/tf-frontend/lcov.info ]; then
  #           echo "Coverage file size:"
  #           du -h tf-frontend/coverage/tf-frontend/lcov.info
  #           echo "First 20 lines of lcov.info:"
  #           head -20 tf-frontend/coverage/tf-frontend/lcov.info
  #         fi

  #     - name: SonarCloud Scan
  #       uses: SonarSource/sonarcloud-github-action@master
  #       continue-on-error: true  # No bloquear el pipeline si falla el Quality Gate
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ============================================
  # FASE 3: Builds en paralelo (después de tests)
  # ============================================
  build-userapi:
    name: Build Backend Image
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    env:
      PROJECT_ID: final-ingsoft3-2025-480515
      REGION: us-central1
      REGISTRY_HOST: us-central1-docker.pkg.dev
    outputs:
      image: ${{ steps.publish.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: final-ingsoft3-2025-480515

      - name: Configure Docker auth
        run: gcloud auth configure-docker $REGISTRY_HOST

      - id: vars
        run: |
          IMAGE="${REGISTRY_HOST}/${PROJECT_ID}/${REPOSITORY}/userapi:${GITHUB_SHA}"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

      - name: Build backend image
        run: docker build -t ${{ steps.vars.outputs.image }} ./APIs/UserAPI

      - name: Push backend image
        run: docker push ${{ steps.vars.outputs.image }}

      - id: publish
        run: echo "image=${{ steps.vars.outputs.image }}" >> $GITHUB_OUTPUT

  build-frontend-qa:
    name: Build Frontend Image (QA)
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    env:
      PROJECT_ID: final-ingsoft3-2025-480515
      REGION: us-central1
      REGISTRY_HOST: us-central1-docker.pkg.dev
    outputs:
      image: ${{ steps.publish.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: final-ingsoft3-2025-480515

      - name: Configure Docker auth
        run: gcloud auth configure-docker $REGISTRY_HOST

      - id: vars
        run: |
          IMAGE="${REGISTRY_HOST}/${PROJECT_ID}/${REPOSITORY}/frontend-qa:${GITHUB_SHA}"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

      - name: Build frontend QA image
        run: docker build --build-arg BUILD_ENV=qa -t ${{ steps.vars.outputs.image }} ./tf-frontend

      - name: Push frontend QA image
        run: docker push ${{ steps.vars.outputs.image }}

      - id: publish
        run: echo "image=${{ steps.vars.outputs.image }}" >> $GITHUB_OUTPUT

  # ============================================
  # FASE 4: Deploy a QA en paralelo
  # ============================================
  deploy-qa:
    name: Deploy Backend to QA
    needs: [build-userapi]
    runs-on: ubuntu-latest
    environment:
      name: qa
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Clear existing configuration
        run: |
          gcloud run services update userapi-qa \
            --region=us-central1 \
            --clear-env-vars \
            --clear-secrets || true

      - uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to QA
        run: |
          gcloud run deploy userapi-qa \
            --image ${{ needs.build-userapi.outputs.image }} \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "ALGORITHM=HS256,ACCESS_TOKEN_EXPIRE_MINUTES=30" \
            --set-secrets "DATABASE_URL=DATABASE_URL:latest,SECRET_KEY=SECRET_KEY:latest,EMAIL_USER=EMAIL_USER:latest,EMAIL_PASSWORD=EMAIL_PASSWORD:latest,INTERNAL_SERVICE_API_KEY=INTERNAL_SERVICE_API_KEY:latest" \
            --add-cloudsql-instances=final-ingsoft3-2025-480515:us-central1:userapi-db \
            --service-account=userapi-service-account@final-ingsoft3-2025-480515.iam.gserviceaccount.com

  deploy-frontend-qa:
    name: Deploy Frontend to QA
    needs: [build-frontend-qa]
    runs-on: ubuntu-latest
    environment:
      name: qa
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Frontend to QA
        run: |
          gcloud run deploy frontend-qa \
            --image ${{ needs.build-frontend-qa.outputs.image }} \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated \
            --port=8080

  # ============================================
  # FASE 5: Smoke Tests
  # ============================================
  smoke-tests:
    name: Smoke Tests QA
    needs: [deploy-qa, deploy-frontend-qa]
    runs-on: ubuntu-latest
    steps:
      - name: Wait for services to be ready
        run: sleep 10

      - name: Test Backend Health
        run: |
          echo "Testing backend API health..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://userapi-qa-737714447258.us-central1.run.app/)
          echo "Backend response code: $RESPONSE"
          if [ "$RESPONSE" != "200" ] && [ "$RESPONSE" != "404" ]; then
            echo "Backend health check failed with code: $RESPONSE"
            exit 1
          fi
          echo "✅ Backend is responding"

      - name: Test Backend API Endpoint
        run: |
          echo "Testing backend API endpoint..."
          RESPONSE=$(curl -s https://userapi-qa-737714447258.us-central1.run.app/api/v1/health 2>&1 || echo '{"status":"unknown"}')
          echo "Backend API response: $RESPONSE"
          echo "✅ Backend API is accessible"

      - name: Test Frontend Health
        run: |
          echo "Testing frontend health..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://frontend-qa-737714447258.us-central1.run.app/)
          echo "Frontend response code: $RESPONSE"
          if [ "$RESPONSE" != "200" ]; then
            echo "Frontend health check failed with code: $RESPONSE"
            exit 1
          fi
          echo "✅ Frontend is responding"

      - name: Test Frontend Loads
        run: |
          echo "Testing if frontend HTML loads..."
          CONTENT=$(curl -s https://frontend-qa-737714447258.us-central1.run.app/)
          if echo "$CONTENT" | grep -q "app-root"; then
            echo "✅ Frontend HTML contains app-root"
          else
            echo "❌ Frontend HTML does not contain expected content"
            exit 1
          fi

  # ============================================
  # FASE 6: Cypress Tests
  # ============================================
  cypress-tests:
    name: Cypress Integration Tests
    needs: [smoke-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tf-frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd tf-frontend
          npm ci

      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        with:
          working-directory: tf-frontend
          browser: chrome
          config: baseUrl=https://frontend-qa-737714447258.us-central1.run.app
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
        continue-on-error: false

      - name: Upload Cypress screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: tf-frontend/cypress/screenshots
          if-no-files-found: ignore

      - name: Upload Cypress videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: tf-frontend/cypress/videos
          if-no-files-found: ignore

  # ============================================
  # FASE 7: Deploy Production + Build Frontend Prod en paralelo
  # ============================================
  deploy-production:
    name: Deploy Backend to Production
    needs: [cypress-tests, build-userapi]
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Clear existing configuration
        run: |
          gcloud run services update userapi \
            --region=us-central1 \
            --clear-env-vars \
            --clear-secrets || true

      - uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Production
        run: |
          gcloud run deploy userapi \
            --image ${{ needs.build-userapi.outputs.image }} \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "ALGORITHM=HS256,ACCESS_TOKEN_EXPIRE_MINUTES=120" \
            --set-secrets "DATABASE_URL=DATABASE_URL:latest,SECRET_KEY=SECRET_KEY:latest,EMAIL_USER=EMAIL_USER:latest,EMAIL_PASSWORD=EMAIL_PASSWORD:latest,INTERNAL_SERVICE_API_KEY=INTERNAL_SERVICE_API_KEY:latest" \
            --add-cloudsql-instances=final-ingsoft3-2025-480515:us-central1:userapi-db \
            --service-account=userapi-service-account@final-ingsoft3-2025-480515.iam.gserviceaccount.com

  build-frontend-prod:
    name: Build Frontend Image (Prod)
    needs: [cypress-tests]
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: final-ingsoft3-2025-480515
      REGION: us-central1
      REGISTRY_HOST: us-central1-docker.pkg.dev
    outputs:
      image: ${{ steps.publish.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: final-ingsoft3-2025-480515

      - name: Configure Docker auth
        run: gcloud auth configure-docker $REGISTRY_HOST

      - id: vars
        run: |
          IMAGE="${REGISTRY_HOST}/${PROJECT_ID}/${REPOSITORY}/frontend-prod:${GITHUB_SHA}"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

      - name: Build frontend production image
        run: docker build --build-arg BUILD_ENV=production -t ${{ steps.vars.outputs.image }} ./tf-frontend

      - name: Push frontend production image
        run: docker push ${{ steps.vars.outputs.image }}

      - id: publish
        run: echo "image=${{ steps.vars.outputs.image }}" >> $GITHUB_OUTPUT

  # ============================================
  # FASE 8: Deploy Frontend Production
  # ============================================
  deploy-frontend-prod:
    name: Deploy Frontend to Production
    needs: [build-frontend-prod]
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Frontend to Production
        run: |
          gcloud run deploy frontend \
            --image ${{ needs.build-frontend-prod.outputs.image }} \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated \
            --port=8080
